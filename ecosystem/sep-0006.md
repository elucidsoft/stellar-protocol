## Preamble

```
SEP: 0006
Title: Anchor/Client interoperability
Author: stellar.org
Status: Accepted
Created: 2017-10-30
Updated: 2018-07-15
Version 2.0.0
```

## Simple Summary

This SEP defines the standard way for anchors and wallets to interact on behalf of users. This improves user experience by allowing wallets and other clients to interact with anchors directly without the user needing to leave the wallet to go to the anchor's site.

## Abstract

This proposal defines a standard protocol enabling the following features directly within a wallet or other Stellar client:

* Deposit external funds with an anchor, which then issues tokens on the Stellar network to the user
* Withdraw funds via a payment to the anchor, which then sends external funds to the user
* Communicate deposit & withdrawal fee structure for an anchor to the user
* Handle anchor KYC needs, including transmitting KYC information about the user to the anchor
* Check the status of ongoing or past deposits and withdrawals involving the user

To support this protocol an anchor acts as a server and implements the specified REST API endpoints, while a wallet implements a client that consumes the API implemented by anchors. The goal is interoperability, so a wallet implements a single client according to the protocol, and will be able to interact with any compliant anchor. Similarly, an anchor that implements the API endpoints according to the protocol will work with any compliant wallet.

## Anchor Servers

This protocol requires an anchor to implement two servers:

1. The deposit server
1. The federation server

They can have the same URL, or they can be completely independent. They are separated only to allow additional flexibility for anchors.

An anchor must define the location of their deposit and federation servers in its [`stellar.toml`](./sep-0001.md) with the `DEPOSIT_SERVER` and `FEDERATION_SERVER`. This is how a wallet knows where to find the anchor's servers.

## API Endpoints

* [`GET /deposit`](#deposit): required
* [`GET /withdrawal`](#withdrawal): required
* [`GET /transactions`](#transaction-history): optional, but strongly recommended
* [`GET /nonce`](#nonce): optional, but necessary for authentication (step 1)
* [`GET /jwt`](#jwt): optional, but necessary for authentication (step 2)
* [`POST /customer`](#customer): optional, but necessary if anchor desires any information about the customer for KYC or other purposes. Requires authentication (`/nonce` and `/jwt`)

## Deposit

A deposit is when a user sends an external token (BTC via Bitcoin, USD via bank transfer, etc...) to an address held by an anchor. In turn, the anchor sends an equal amount of tokens on the Stellar network (minus fees) to the user's Stellar account.

The deposit endpoint allows a wallet to get deposit information from an anchor, so a user has all the information needed to initiate a deposit. It also lets the issuer specify additional information (if desired) that the user must submit via the `/customer` endpoint to be able to deposit.

### Request

```
GET DEPOSIT_SERVER/deposit
```

Request Parameters:

Name | Type | Description
-----|------|------------
`asset_code` | string | The code of the asset the user is wanting to deposit with the anchor. Ex BTC,ETH,USD,INR,etc
`account` | `G...` string | The stellar account ID of the user that wants to deposit. This is where the asset token will be sent.
`memo_type` | string | (optional) type of memo that issuer should attach to the Stellar payment transaction, one of `text`, `id` or `hash`
`memo` | string | (optional) value of memo to attach to transaction, for `hash` this should be base64-encoded.

Example:

```
GET https://api.example.com/deposit?asset_code=ETH&account=GACW7NONV43MZIFHCOKCQJAKSJSISSICFVUJ2C6EZIW5773OU3HD64VI
```

If the given Stellar `account` doesn't exist yet then the anchor will fund and thus create the account with at least enough `XLM` for the minimum reserve and a trust line. It is suggested that the anchor take some of the asset that is sent in to pay for the `XLM`. The anchor doesn't have the user account's secret key so the user must create a trust line to the anchor's asset before the anchor can send the remaining asset tokens to the user's account. The anchor should listen to see when the user has established this trust line. Once the trust line is there the anchor should send the asset tokens to the account in Stellar to complete the deposit.

If the anchor won't create new accounts for users, it should return a `400 Bad Request` error if the  `account` doesn't exist yet.

### Response

There are five possible kinds of response, depending on whether the issuer needs more information about the user, how it should be sent to the issuer, and if there are any errors.

The first response, the success response, is explained below. The other four possible responses are shared with the withdrawal endpoint, and are explained in the [Deposit and Withdrawal shared responses](#deposit-and-withdrawal-shared-responses) section below.

#### 1. Success: no additional information needed

Response code: `200 OK`

This is the correct response if the issuer is able to accept the deposit and needs no additional information about the user. It should also be used if the issuer requires information about the user, but the information has previously been submitted and accepted.


The response body should be a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`how` | string | Instructions for how to deposit the asset. In the case of cryptocurrency it is just an address to which the deposit should be sent.
`eta` | int | (optional) Estimate of how long the deposit will take to credit in seconds.
`min_amount` | float | (optional) Minimum amount of an asset that a user can deposit.
`max_amount` | float | (optional) Maximum amount of asset that a user can deposit.
`fee_fixed` | float | (optional) Fixed fee (if any). In units of the deposited asset.
`fee_percent` | float | (optional) Percentage fee (if any). In units of percentage points.
`extra_info` | object | (optional) Any additional data needed as an input for this deposit, example: Bank Name

Example:

```json
{
  "how" : "1Nh7uHdvY6fNwtQtM1G5EZAFPLC33B59rB",
  "fee_fixed" : 0.0002
}
```

## Withdraw

Wallets and exchanges wishing to withdraw assets from an issuer use the existing [federation](../ecosystem/sep-0002.md) `forward` type, which returns the Stellar account and memo where the user should send the asset to be withdrawn. This operation allows a user to redeem an asset currently on the Stellar network for the real asset (BTC, USD, stock, etc...) via the issuer of the Stellar asset.

### Request

```
GET FEDERATION_SERVER/federation
```

Request parameters:

Name | Type | Description
-----|------|------------
`type` | string | forward
`forward_type` | string | `bank_account` or `crypto`
`asset_code` | string | Specify the code of the asset you are withdrawing.
`dest` | string | (for crypto) The account you want to withdraw to.
`dest_extra` | string | (optional) If needed for other networks that might need a memo in addition to the `dest` address.

Example:

```
GET https://api.example.com/federation?type=forward&forward_type=crypto&asset_code=ETH&dest=GACW7NONV43MZIFHCOKCQJAKSJSISSICFVUJ2C6EZIW5773OU3HD64VI
```

### Response

There are five possible kinds of response, depending on whether the issuer needs more information about the user, how it should be sent to the issuer, and if there are any errors.

The first response, the success response, is explained below. The other four possible responses are shared with the deposit endpoint, and are explained in the [Deposit and Withdrawal shared responses](#deposit-and-withdrawal-shared-responses) section directly below.

#### 1. Success: no additional information needed

Response code: `200 OK`

This is the correct response if the issuer is able to execute the withdrawal and needs no additional information about the user. It should also be used if the issuer requires information about the user, but the information has previously been submitted and accepted.

The response body should be a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`account_id` | `G...` string | The account the user should send its token back to.
`memo_type` | string | (optional) type of memo to attach to transaction, one of `text`, `id` or `hash`
`memo` | string | (optional) value of memo to attach to transaction, for `hash` this should be base64-encoded.
`eta` | int | (optional) Estimate of how long the withdrawal will take to credit in seconds.
`min_amount` | float | (optional) Minimum amount of an asset that a user can withdraw.
`max_amount` | float | (optional) Maximum amount of asset that a user can withdraw.
`fee_fixed` | float | (optional) If there is a fee for withdraw. In units of the withdrawn asset.
`fee_percent` | float | (optional) If there is a percent fee for withdraw.
`extra_info` | object | (optional) Any additional data needed as an input for this withdraw, example: Bank Name

Example:

```json
{
  "account_id": "GCIBUCGPOHWMMMFPFTDWBSVHQRT4DIBJ7AD6BZJYDITBK2LCVBYW7HUQ",
  "memo_type": "id",
  "memo": "123"
}
```

## Deposit and Withdrawal shared responses

### 2. Customer information needed (non-interactive)

Response code: `403 Forbidden`

If the issuer needs more information about the customer and all the information can be received non-interactively via the `/customer` endpoint, this is the correct response. Once the user / wallet transmits information to the `/customer` endpoint, they can retry the deposit or withdrawal endpoint to see if the issuer is ready to execute the deposit or withdrawal.

The response body should be a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`type` | string | Always set to `non_interactive_customer_info_needed`
`fields` | list of strings | A list of fields that need to be transmitted to the `/customer` endpoint for the deposit to proceed.

Example:

```json
{
  "type": "non_interactive_customer_info_needed",
  "fields" : ["family_name", "given_name", "address", "taxid"],
}
```

### 3. Customer information needed (interactive)

Response code: `403 Forbidden`

An issuer that requires the user to fill out information on a webpage hosted by the issuer should use this response. A wallet that receives this response should open a popup browser window to the specified URL.

The response body should be a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`type` | string | Always set to `interactive_customer_info_needed`
`url` | string | URL hosted by the issuer. The wallet should pop up a browser window to this URL.

If the wallet wants to be notified that the user has completed the required actions via the URL, it can add an extra `callback` parameter to the value of `url` before opening the browser window. If the `callback` value is a URL, the issuer should visit it once the user has successfully completed the process. If `callback=postMessage` is passed, the issuer should post `success` to `window.opener` via the Javascript `Window.postMessage` method. Alternately, the wallet can always poll the original deposit or withdrawal endpoint until a success, status `denied`, or error response is returned.

Example:

```json
{
  "type": "interactive_customer_info_needed",
  "url" : "https://api.example.com/kycflow?account=GACW7NONV43MZIFHCOKCQJAKSJSISSICFVUJ2C6EZIW5773OU3HD64VI"
}
```

### 4. Customer Information Status

Response code: `403 Forbidden`

An issuer should use this response if customer information was submitted for the `account`, but the information is either still being processed or was not accepted.

Name | Type | Description
-----|------|------------
`type` | string | Always set to "customer_info_status"
`status` | string | Status of customer information processing. One of: `pending`, `denied`
`more_info_url` | string | (optional) A URL the user can visit if they want more information about their account / status.
`eta` | int | (optional) Estimated number of seconds until the deposit status will update.

If the issuer decides that more customer information is needed after receiving some information and processing it, it can respond again with a response of type `interactive_customer_info_needed` or `non_interactive_customer_info_needed`. In the case of a `denied` request, an issuer can use the `more_info_url` to explain to the user the issue with their request and give them a way to rectify it manually. A wallet should show the `more_info_url` to the user when explaining that the request was denied.

Example:

```json
{
  "type": "status",
  "status": "denied",
  "more_info_url": "https://api.example.com/kycstatus?account=GACW7NONV43MZIFHCOKCQJAKSJSISSICFVUJ2C6EZIW5773OU3HD64VI"
}
```

### 5. Error

Every other HTTP status code will be considered an error. The body should contain error details.
For example:

```json
{
   "error": "This anchor doesn't support the given currency code: ETH"
}
```

## Transaction History

The transaction history endpoint helps anchors enable a better experience for users using an external wallet. With it, wallets can display the status of deposits and withdrawals while they process and a history of past transactions with the anchor. It's only for transactions that are deposits to or withdrawals from the anchor.

Endpoint: `DEPOSIT_SERVER/transactions`<br>
Purpose: Get status of current and past deposits/withdrawals.<br>
Method: GET<br>
Request parameters

Name | Type | Description
-----|------|------------
`asset_code` | string | The code of the asset of interest. E.g. BTC,ETH,USD,INR,etc
`account` | string | The stellar account ID involved in the transactions
`no_older_than` | UTC ISO 8601 string | (optional) The response should contain transactions starting on or after this date & time
`limit` | int | (optional) the response should contain at most `limit` transactions
`paging_id` | string | (optional) the response should contain transactions starting prior to this ID (exclusive)

On success the endpoint should return `200 OK` HTTP status code and a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`transactions` | array | List of transactions as requested by the client, sorted in time-descending order

Each object in the `transactions` array should have the following fields:

Name | Type | Description
-----|------|------------
`id` | string | Unique, anchor-generated id for the deposit/withdrawal
`kind` | string | `deposit` or `withdrawal`
`status` | string | Processing status of deposit/withdrawal
`status_eta` | number | (optional) Estimated number of seconds until a status change is expected
`amount_in` | string | (optional) Amount received by anchor at start of transaction as a string with up to 7 decimals. Excludes any fees charged before the anchor received the funds.
`amount_out` | string | (optional) Amount sent by anchor to user at end of transaction as a string with up to 7 decimals. Excludes amount converted to XLM to fund account and any external fees
`amount_fee` | string | (optional) Amount of fee charged by issuer
`started_at` | UTC ISO 8601 string | (optional) start date and time of transaction
`completed_at` | UTC ISO 8601 string | (optional) completion date and time of transaction
`stellar_transaction_id` | string | (optional) transaction_id on Stellar network of the transfer that either completed the deposit or started the withdrawal
`external_transaction_id` | string | (optional) ID of transaction on external network that either started the deposit or completed the withdrawal
`message` | string | (optional) Human readable explanation of transaction status, if needed.

`status` should be one of:

* `completed` -- deposit/withdrawal fully completed
* `pending_external` -- deposit/withdrawal has been submitted to external network, but is not yet confirmed. This is the status when waiting on Bitcoin or other external crypto network to complete a transaction, or when waiting on a bank transfer.
* `pending_anchor` -- deposit/withdrawal is being processed internally by anchor
* `pending_stellar` -- deposit/withdrawal operation has been submitted to Stellar network, but is not yet confirmed
* `pending_trust` -- the user must add a trust-line for the asset for the deposit to complete
* `pending_user` -- the user must take additional action before the deposit / withdrawal can complete
* `no_market` -- could not complete deposit because no satisfactory asset/XLM market was available to create the account
* `too_small` -- deposit/withdrawal size less than `min_amount`
* `too_large` -- deposit/withdrawal size exceeded `max_amount`

Example response:

```json
{
  "transactions": [
    {
      "id": "82fhs729f63dh0v4",
      "kind": "deposit",
      "status": "pending_external",
      "status_eta": 3600,
      "external_transaction_id": "2dd16cb409513026fbe7defc0c6f826c2d2c65c3da993f747d09bf7dafd31093",
      "amount_in": "18.34",
      "amount_out": "18.24",
      "amount_fee": "0.1",
      "started_at": "2017-03-20T17:05:32Z"
    },
    {
      "id": "82fhs729f63dh0v4",
      "kind": "withdrawal",
      "status": "completed",
      "amount_in": "500",
      "amount_out": "495",
      "amount_fee": "3",
      "started_at": "2017-03-20T17:00:02Z",
      "completed_at": "2017-03-20T17:09:58Z",
      "stellar_transaction_id": "17a670bc424ff5ce3b386dbfaae9990b66a2a37b4fbe51547e8794962a3f9e6a",
      "external_transaction_id": "2dd16cb409513026fbe7defc0c6f826c2d2c65c3da993f747d09bf7dafd31093"
    }
  ]
}
```

Every HTTP status code other than `200 OK` will be considered an error. An empty transaction list is *not* an error. The body should contain error details.
For example:

```json
{
   "error": "This anchor doesn't support the given currency code: ETH"
}
```

## Nonce

An issuer can implement this endpoint to allow user authentication. The endpoint must return a random base64-encoded string with at least 128 bits of entropy. A wallet makes a request to this endpoint to begin the authentication process. A random, issuer-picked value is essential for an authentication process that is resistant to replay attacks. The issuer must store the `<nonce, account>` pair for 5-10 minutes, after which it should be deleted. An issuer is at liberty to rate limit requests as needed.

### Request

```
GET DEPOSIT_SERVER/nonce
```

Request Parameters:

Name | Type | Description
-----|------|------------
`account` | `G...` string | The stellar account that the wallet wishes to authenticate to the issuer

Example:

```
GET https://api.example.com/nonce?account=GCIBUCGPOHWMMMFPFTDWBSVHQRT4DIBJ7AD6BZJYDITBK2LCVBYW7HUQ
```

### Response

On success the endpoint should return `200 OK` HTTP status code and a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`nonce` | string | A cryptographic-quality random string base64 encoded with at least 128 bits of entropy

Example:
```
{
  "nonce": "Pq6WVhFd55yojWmLbxVY5clUEifrK9AIQyhmmchEt0wR"
}
```

Every other HTTP status code will be considered an error. For example:

```json
{
   "error": "The provided account has requested too many nonces recently. Try again later."
}
```

## JWT

An issuer can implement this endpoint to allow user authentication. The endpoint accepts a nonce, an account, and a signature of that nonce with the secret key for the account. If the signature is valid, it responds with a [JSON Web Token](https://jwt.io/) authenticating the user. An issuer can pick its own expiration period for the token, however 24 hours is recommended.

### Request

```
GET DEPOSIT_SERVER/token
```

Request Parameters:

Name | Type | Description
-----|------|------------
`account` | `G...` string | The stellar account that the wallet wishes to authenticate to the issuer
`nonce` | string | A valid nonce that was recently returned by the issuer for this account
`signature` | string | A base64 signature of the nonce string generated with the secret key to the `account`

Note that since both `nonce` and `signature` are base64 encoded, they'll also need to be URL-encoded before using in the `GET` request.

Example:

```
GET https://api.example.com/jwt?account=GCIBUCGPOHWMMMFPFTDWBSVHQRT4DIBJ7AD6BZJYDITBK2LCVBYW7HUQ&nonce=naV4YT7RXnXn4EdN6Z%2B9UltDfftk1uvb6yCmf7bLrs4%3D&signature=ASDF
```

### Response

If the signature and nonce are both valid, the issuer generates a JWT and puts it in the response body. The JWT must encode the user's account ID in the `sub` field as well as the time of issuance. No other fields are needed.

On success the endpoint should return `200 OK` HTTP status code and a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`jwt` | string | The JWT that a user can use to authenticate future endpoint calls with the issuer


Example:
```
{
  "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c"
}
```

Every other HTTP status code will be considered an error. For example:

```json
{
   "error": "The provided nonce is not valid"
}
```

## Customer

This issuer endpoint allows a wallet or exchange to upload information about the customer (chiefly KYC information) on the customer's behalf. It is often used following a `/deposit` or `/federation?type=forward` request that responds with `non_interactive_customer_info_needed`. The endpoint accommodates KYC data that is large or binary formatted (image of driver's license, photo of bill for proof of address, etc...). A wallet may make multiple requests to `/customer` to upload data, and the endpoint is idempotent. 

### Request

```
PUT DEPOSIT_SERVER/customer
Content-Type: multipart/form-data
```

The fields below should be placed in the request body using the `multipart/form-data` encoding.

Name | Type | Description
-----|------|------------
`account` | `G...` string | The Stellar account ID to upload KYC data for
`jwt` | string | The JWT previously sent by the issuer via the `/jwt` endpoint
`memo` | string | (optional) If included, the KYC data will only apply to deposit/withdraw requests that include this `memo`. It can be a substring of the full transaction `memo` but must be unique to one customer.

The wallet may transmit any of the following kinds of standardized customer information, depending on what the issuer has requested:

Name | Type | Description
-----|------|------------
`family_name` | string | Family or last name
`given_name` | string | Given or first name
`additional_name` | string | May be used for middle name
`country_code` | string | 2-digit standard country code
`postal_code` | string | Postal or other code identifying user's region
`phone_number` | string | Phone number with country code
`bank_account_number` | string | Number identifying bank account
`bank_number` | string | Number identifying bank (routing number in US)
`bank_phone_number` | string | Phone number with country code for bank
`address` | string | Entire address represented as a string
`tax_id` | string | Tax identifier of user in their country (social security number in US)
`date_of_birth` | ISO8601 date string | Date of birth, e.g. "1976-07-04"
`employer_name` | string | Name of employer
`employer_address` | string | address of employer
`photo_id_front` | binary | Image of front of user's photo ID or passport
`photo_id_back` | binary | Image of back of user's photo ID or passport
`notary_approval_of_photo_id` | binary | Image of notary's approval of photo ID or passport

### Response

If the issuer received and stored the data successfully, it should respond with a `202 Accepted` HTTP status code and an empty body.

Every other HTTP status code will be considered an error. The body should contain error details.
For example:

```json
{
   "error": "'photo_id_front' cannot be decoded. Must be jpg or png."
}
```
