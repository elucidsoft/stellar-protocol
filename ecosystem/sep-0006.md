## Preamble

```
SEP: 0006
Title: Anchor/Client interoperability
Author: stellar.org
Status: Accepted
Created: 2017-10-30
Updated: 2018-05-01
Version 2.0.0
```

## Simple Summary

This SEP defines the standard way for anchors and wallets to interact on behalf of users. This improves user experience by allowing wallets and other clients to interact with anchors directly without the user needing to leave the wallet to go to the anchor's site.

## Abstract

This proposal defines a standard protocol enabling the following features directly within a wallet or other Stellar client:

* Deposit external funds with an anchor, which then issues tokens on the Stellar network to the user
* Withdraw funds via a payment to the anchor, which then sends external funds to the user
* Communicate deposit & withdrawal fee structure for an anchor to the user
* Handle anchor KYC needs, including transmitting KYC information about the user to the anchor
* Check the status of ongoing or past deposits and withdrawals involving the user

To support this protocol an anchor acts as a server and implements the specified REST API endpoints, while a wallet implements a client that consumes the API implemented by anchors. The goal is interoperability, so a wallet implements a single client according to the protocol, and will be able to interact with any compliant anchor. Similarly, an anchor that implements the API endpoints according to the protocol will work with any compliant wallet.

## Specification

### Anchor Servers

This protocol requires an anchor to implement two servers:

1. The deposit server
1. The federation server

They can have the same URL, or they can be completely independent. They are separated only to allow additional flexibility for anchors.

An anchor must define the location of their deposit and federation servers in its [`stellar.toml`](./sep-0001.md) with the `DEPOSIT_SERVER` and `FEDERATION_SERVER`. This is how a wallet knows where to find the anchor's servers.

### API Endpoints

* [`GET /deposit`](#deposit): required
* [`GET /withdrawal`](#withdrawal): required
* [`GET /transactions`](#transactions): optional, but strongly recommended
* [`POST /customer`](#customer): optional, but necessary if anchor desires any information about the customer for KYC or other purpose

### Deposit

A deposit is when a user sends an external token (BTC via Bitcoin, USD via bank transfer, etc...) to an address held by an anchor. In turn, the anchor sends an equal amount of tokens on the Stellar network (minus fees) to the user's Stellar account.

The deposit endpoint allows a wallet to get deposit information from an anchor, so a user has all the information needed to initiate a deposit. It also lets the issuer specify additional information (if desired) that the user must submit via the `/customer` endpoint to be able to deposit.

#### Request

```
GET DEPOSIT_SERVER/deposit
```

Request Parameters:

Name | Type | Description
-----|------|------------
`asset_code` | string | The code of the asset the user is wanting to deposit with the anchor. Ex BTC,ETH,USD,INR,etc
`account` | string | The stellar account ID of the user that wants to deposit. This is where the asset token will be sent.
`memo_type` | string | (optional) type of memo that issuer should attach to the Stellar payment transaction, one of `text`, `id` or `hash`
`memo` | string | (optional) value of memo to attach to transaction, for `hash` this should be base64-encoded.

Example:

```
https://apay.io/api/deposit?asset_code=ETH&account=GACW7NONV43MZIFHCOKCQJAKSJSISSICFVUJ2C6EZIW5773OU3HD64VI
```

If the given Stellar `account` doesn't exist yet then the anchor will fund and thus create the account with at least enough `XLM` for the minimum reserve and a trust line. It is suggested that the anchor take some of the asset that is sent in to pay for the `XLM`. The anchor doesn't have the user account's secret key so the user must create a trust line to the anchor's asset before the anchor can send the remaining asset tokens to the user's account. The anchor should listen to see when the user has established this trust line. Once the trust line is there the anchor should send the asset tokens to the account in Stellar to complete the deposit.

If the anchor won't create new accounts for users, it should return an error if the  `account` doesn't exist yet.

#### Response

There are four possible kinds of response, depending on whether the issuer needs more information about the user, how it should be sent to the issuer, and if there are any errors.

##### 1. Success: no additional information needed

Response code: `200 OK`

This is the correct response if the issuer is able to accept the deposit and needs no additional information about the user.

The response body should be a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`how` | string | Instructions for how to deposit the asset. In the case of cryptocurrency it is just an address to which the deposit should be sent.
`eta` | int | (optional) Estimate of how long the deposit will take to credit in seconds.
`min_amount` | float | (optional) Minimum amount of an asset that a user can deposit.
`max_amount` | float | (optional) Maximum amount of asset that a user can deposit.
`fee_fixed` | float | (optional) Fixed fee (if any). In units of the deposited asset.
`fee_percent` | float | (optional) Percentage fee (if any). In units of percentage points.
`extra_info` | object | (optional) Any additional data needed as an input for this deposit, example: Bank Name

Example:

```json
{
  "how" : "1Nh7uHdvY6fNwtQtM1G5EZAFPLC33B59rB",
  "fee_fixed" : 0.0002
}
```

Every HTTP status code other than `200 OK` will be considered an error. The body should contain error details.
For example:

```json
{
  "error": "This anchor doesn't support the given currency code: ETH"
}
```

### Withdraw

Withdrawals use the existing [federation](../ecosystem/sep-0002.md) `forward` type and will return the Stellar account and memo where the user should send the asset to be withdrawn. The implicit understanding here is that the anchor is the issuer and we are redeeming the underlying asset from them in exchange for the token they issued to us in Stellar.

Endpoint: `FEDERATION_SERVER/federation`<br>
Purpose: Get the Stellar account and memo to send withdraw the asset to.<br>
Method: GET<br>
Request parameters

Name | Type | Description
-----|------|------------
`type` | string | forward
`forward_type` | string | either {bank_account,crypto}
`asset_code` | string | (for crypto) Specify the code of the asset you are withdrawing.
`dest` | string | (for crypto) The account you want to withdraw to.
`dest_extra` | string | (optional) If needed for other networks that might need a memo in addition to the `dest` address.

On success the endpoint should return `200 OK` HTTP status code and a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`account_id` | string | The account the user should send its token back to.
`memo_type` | string | (optional) type of memo to attach to transaction, one of `text`, `id` or `hash`
`memo` | string | (optional) value of memo to attach to transaction, for `hash` this should be base64-encoded.
`eta` | int | (optional) Estimate of how long the withdrawl will take to credit in seconds.
`min_amount` | float | (optional) Minimum amount of an asset that a user can withdraw.
`max_amount` | float | (optional) Maximum amount of asset that a user can withdraw.
`fee_fixed` | float | (optional) If there is a fee for withdraw. In units of the withdrawn asset.
`fee_percent` | float | (optional) If there is a percent fee for withdraw.
`extra_info` | object | (optional) Any additional data needed as an input for this withdraw, example: Bank Name

Example:

```json
{
  "account_id": "GCIBUCGPOHWMMMFPFTDWBSVHQRT4DIBJ7AD6BZJYDITBK2LCVBYW7HUQ",
  "memo_type": "id",
  "memo": "123"
}
```

Every other HTTP status code will be considered an error. The body should contain error details.
For example:

```json
{
   "error": "This anchor doesn't support the given currency code: ETH"
}
```

### Transaction History

The transaction history endpoint helps anchors enable a better experience for users using an external wallet. With it, wallets can display the status of deposits and withdrawals while they process and a history of past transactions with the anchor. It's only for transactions that are deposits to or withdrawals from the anchor.

Endpoint: `DEPOSIT_SERVER/transactions`<br>
Purpose: Get status of current and past deposits/withdrawals.<br>
Method: GET<br>
Request parameters

Name | Type | Description
-----|------|------------
`asset_code` | string | The code of the asset of interest. E.g. BTC,ETH,USD,INR,etc
`account` | string | The stellar account ID involved in the transactions
`no_older_than` | UTC ISO 8601 string | (optional) The response should contain transactions starting on or after this date & time
`limit` | int | (optional) the response should contain at most `limit` transactions
`paging_id` | string | (optional) the response should contain transactions starting prior to this ID (exclusive)

On success the endpoint should return `200 OK` HTTP status code and a JSON object with the following fields:

Name | Type | Description
-----|------|------------
`transactions` | array | List of transactions as requested by the client, sorted in time-descending order

Each object in the `transactions` array should have the following fields:

Name | Type | Description
-----|------|------------
`id` | string | Unique, anchor-generated id for the deposit/withdrawal
`kind` | string | `deposit` or `withdrawal`
`status` | string | Processing status of deposit/withdrawal
`status_eta` | number | (optional) Estimated number of seconds until a status change is expected
`amount` | string | (optional) Amount of deposit/withdrawal as a string with up to 7 decimals
`started_at` | UTC ISO 8601 string | (optional) start date and time of transaction
`completed_at` | UTC ISO 8601 string | (optional) completion date and time of transaction
`stellar_transaction_id` | string | (optional) transaction_id on Stellar network of the transfer that either completed the deposit or started the withdrawal
`external_transaction_id` | string | (optional) ID of transaction on external network that either started the deposit or completed the withdrawal

`status` should be one of:

* `completed` -- deposit/withdrawal fully completed
* `pending_external` -- deposit/withdrawal has been submitted to external network, but is not yet confirmed. This is the status when waiting on Bitcoin or other external crypto network to complete a transaction, or when waiting on a bank transfer.
* `pending_anchor` -- deposit/withdrawal is being processed internally by anchor
* `pending_stellar` -- deposit/withdrawal operation has been submitted to Stellar network, but is not yet confirmed
* `pending_user` -- deposit operation requires a trustline to be processed. Withdrawal operation requires some additional data from user, for bank transfer, for example.

Example response:

```json
{
  "transactions": [
    {
      "id": "82fhs729f63dh0v4",
      "kind": "deposit",
      "status": "pending_external",
      "status_eta": 3600,
      "external_transaction_id": "2dd16cb409513026fbe7defc0c6f826c2d2c65c3da993f747d09bf7dafd31093",
      "amount": "18.34",
      "started_at": "2017-03-20T17:05:32Z"
    },
    {
      "id": "82fhs729f63dh0v4",
      "kind": "withdrawal",
      "status": "completed",
      "amount": "500",
      "started_at": "2017-03-20T17:00:02Z",
      "completed_at": "2017-03-20T17:09:58Z",
      "stellar_transaction_id": "17a670bc424ff5ce3b386dbfaae9990b66a2a37b4fbe51547e8794962a3f9e6a",
      "external_transaction_id": "2dd16cb409513026fbe7defc0c6f826c2d2c65c3da993f747d09bf7dafd31093"
    }
  ]
}
```

Every other HTTP status code will be considered an error. An empty transaction list is *not* an error. The body should contain error details.
For example:

```json
{
   "error": "This anchor doesn't support the given currency code: ETH"
}
```
